# THIS CONFIG IS FOR USE WITH Octopus 1.1 & Beacon

# Required Configs, Always include these
[include mainsail.cfg]
[include macros/*.cfg]
[include timelapse.cfg]
[include K-ShakeTune/*.cfg]

#####################################################################
#   MCU / Octopus
#####################################################################

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_25002D000150335331383520-if00
#serial: platform-fd500000.pcie-pci-0000:01:00.0-usb-0:1.3:1.0
restart_method: command

[temperature_sensor Octopus]
sensor_type: temperature_mcu
sensor_mcu: mcu
min_temp: 0
max_temp: 100

[temperature_sensor RPi]
sensor_type: temperature_host
min_temp: 10
max_temp: 100


#####################################################################
#   Machine
#####################################################################

[printer]
kinematics: corexy
max_velocity: 500  
max_accel: 10000
max_z_velocity: 15
max_z_accel: 350
square_corner_velocity: 5.0

[idle_timeout]
timeout: 1800


#####################################################################
#   X/Y Stepper Settings
#####################################################################

[stepper_x]
step_pin: PF13
dir_pin: PF12
enable_pin: !PF14
rotation_distance: 40
microsteps: 32
full_steps_per_rotation: 400
endstop_pin: tmc2209_stepper_x:virtual_endstop
position_min: 0
position_endstop: 300
position_max: 300
homing_speed: 40
homing_retract_dist: 0

[tmc2209 stepper_x]
uart_pin: PC4
diag_pin: ^PG6
interpolate: False
run_current: 1.0
sense_resistor: 0.110
stealthchop_threshold: 0
driver_SGTHRS: 140

[stepper_y]
step_pin: PG0
dir_pin: PG1
enable_pin: !PF15
rotation_distance: 40
microsteps: 32
full_steps_per_rotation: 400
endstop_pin: tmc2209_stepper_y:virtual_endstop
position_min: 0
position_endstop: 307
position_max: 307
homing_speed: 40
homing_retract_dist: 0

[tmc2209 stepper_y]
uart_pin: PD11
diag_pin: ^PG9
interpolate: False
run_current: 1.0
sense_resistor: 0.110
stealthchop_threshold: 0
driver_SGTHRS: 140


#####################################################################
#   Z Stepper Settings
#####################################################################

[stepper_z]
step_pin: PF11
dir_pin: !PG3
enable_pin: !PG5
rotation_distance: 4
microsteps: 32
full_steps_per_rotation: 200
endstop_pin: probe:z_virtual_endstop
position_max: 290
position_min: -2.5
homing_speed: 10
second_homing_speed: 3
homing_retract_dist: 0


[tmc2209 stepper_z]
uart_pin: PC6
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_z1]
step_pin: PG4
dir_pin: !PC1
enable_pin: !PA0
rotation_distance: 4
microsteps: 32
full_steps_per_rotation: 200

[tmc2209 stepper_z1]
uart_pin: PC7
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_z2]
step_pin: PF9
dir_pin: !PF10
enable_pin: !PG2
rotation_distance: 4
microsteps: 32
full_steps_per_rotation: 200

[tmc2209 stepper_z2]
uart_pin: PF2
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0


#####################################################################
#   Extruder
#####################################################################

[extruder]
step_pin: PC13
dir_pin: !PF0
enable_pin: !PF1
rotation_distance: 22.50
gear_ratio: 50:8
microsteps: 16
full_steps_per_rotation: 200
nozzle_diameter: 0.400
filament_diameter: 1.75
heater_pin: PA3
sensor_type: PT1000
# pullup_resistor:
sensor_pin: PF4
min_temp: 10
max_temp: 350
max_power: 1.0
min_extrude_temp: 170
max_extrude_only_distance: 500
max_extrude_cross_section: 5.0
pressure_advance: 0.02
pressure_advance_smooth_time: 0.03

[tmc2209 extruder]
uart_pin: PE4
interpolate: false
run_current: 0.60
sense_resistor: 0.110
stealthchop_threshold: 0

[firmware_retraction]
retract_length: 0.5
retract_speed: 35
unretract_extra_length: 0.0
unretract_speed: 35


#####################################################################
#   ADXL / Input Shaper
#####################################################################

[resonance_tester]
accel_chip: beacon
accel_per_hz: 100
probe_points: 150, 150, 20

[input_shaper]
shaper_type_x = mzv
shaper_freq_x = 76.0
damping_ratio_x = 0.036
shaper_type_y = mzv
shaper_freq_y = 46.5
damping_ratio_y = 0.050


#####################################################################
#   Bed Heater
#####################################################################

[heater_bed]
heater_pin: PA2
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF3
max_power: 1
pwm_cycle_time: 0.0166
min_temp: 0
max_temp: 120


#####################################################################
#   Beacon
#####################################################################

[beacon]
serial: /dev/serial/by-id/usb-Beacon_Beacon_RevH_2A25C8345154364134202020FF143F31-if00
x_offset: 0
y_offset: 22
mesh_main_direction: x
mesh_runs: 2
contact_max_hotend_temperature: 270
home_xy_position: 150, 150
home_z_hop: 5
home_z_hop_speed: 30
home_xy_move_speed: 450
home_method: contact
home_method_when_homed: proximity
home_autocalibrate: unhomed
home_gcode_pre_x: _HOME_PRE_AXIS AXIS=X
home_gcode_post_x: _HOME_POST_AXIS AXIS=X
home_gcode_pre_y: _HOME_PRE_AXIS AXIS=Y
home_gcode_post_y: _HOME_POST_AXIS AXIS=Y
autocal_max_retries: 10


#####################################################################
#   Bed Mesh
#####################################################################

[bed_mesh]
speed: 450
mesh_min: 30,30
mesh_max: 270,270
probe_count: 25,25
algorithm: bicubic
zero_reference_position: 150, 150


#####################################################################
#   Z-Tilt
#####################################################################

[z_tilt]
z_positions:
   -50, 18
   150, 348
   350, 18
points:
   30, 8
   150, 258
   270, 8
speed: 450
retries: 10
retry_tolerance: 0.004
horizontal_move_z: 10


#####################################################################
#   Fan Control
#####################################################################

[fan]
pin: PE5
kick_start_time: 0.5
off_below: 0.10

[heater_fan hotend_fan]
pin: PA8
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0

[controller_fan Controller_Fan]
pin: PD12
kick_start_time: 0.5
fan_speed: 0.50
idle_timeout: 1800


#####################################################################
# 	Chamber Thermistor
#####################################################################

[temperature_sensor Chamber]
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF5
min_temp: 0
max_temp: 100
gcode_id: chamber_th

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 20.606
#*# pid_ki = 1.164
#*# pid_kd = 91.181
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 65.636
#*# pid_ki = 4.376
#*# pid_kd = 246.136
#*#
#*# [beacon model default]
#*# model_coef = 1.4275713701467947,
#*# 	  1.742136172468315,
#*# 	  0.781168480560976,
#*# 	  0.4294898583792741,
#*# 	  0.2978580042137412,
#*# 	  0.20646205660429937,
#*# 	  0.026036119952757505,
#*# 	  -0.024294713035791598,
#*# 	  0.06770530450285542,
#*# 	  0.04796733494273525
#*# model_domain = 1.8041102730482652e-07,1.9305312280703798e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 63.878212
#*# model_offset = 0.00000
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.072894, 0.077568, 0.078923, 0.068941, 0.059898, 0.068399, 0.064139, 0.062683, 0.069658, 0.077874, 0.079779, 0.074275, 0.080168, 0.086904, 0.089563, 0.098366, 0.109978, 0.098889, 0.086207, 0.094822, 0.092192, 0.091521, 0.100788, 0.092283, 0.088501
#*# 	  0.071307, 0.067815, 0.064229, 0.051748, 0.054028, 0.062065, 0.051118, 0.050509, 0.058940, 0.067540, 0.066597, 0.060935, 0.063472, 0.075109, 0.079250, 0.088397, 0.090839, 0.085184, 0.084758, 0.086867, 0.079017, 0.079244, 0.090799, 0.083369, 0.075326
#*# 	  0.057977, 0.053396, 0.050944, 0.041531, 0.038545, 0.039338, 0.033861, 0.032686, 0.041266, 0.051819, 0.052260, 0.046267, 0.050903, 0.063554, 0.059639, 0.064950, 0.076186, 0.078072, 0.072859, 0.069491, 0.064917, 0.065668, 0.077559, 0.069008, 0.059485
#*# 	  0.045523, 0.039776, 0.037962, 0.031104, 0.025527, 0.026451, 0.019673, 0.016300, 0.028799, 0.038977, 0.042895, 0.046057, 0.048875, 0.045261, 0.044147, 0.053664, 0.069175, 0.078256, 0.070972, 0.064427, 0.056539, 0.055071, 0.064776, 0.054744, 0.045621
#*# 	  0.035050, 0.035243, 0.029944, 0.022084, 0.019322, 0.019136, 0.009952, 0.004258, 0.012343, 0.029088, 0.058177, 0.067598, 0.065772, 0.054459, 0.034349, 0.049372, 0.068170, 0.081383, 0.078845, 0.067013, 0.053998, 0.048944, 0.053113, 0.046625, 0.033797
#*# 	  0.028709, 0.029257, 0.032108, 0.027282, 0.018297, 0.019473, 0.012470, -0.000732, 0.007007, 0.026203, 0.060479, 0.076922, 0.079148, 0.065826, 0.035459, 0.045100, 0.068891, 0.087958, 0.084038, 0.071589, 0.058702, 0.049065, 0.050301, 0.043958, 0.028002
#*# 	  0.028852, 0.036846, 0.046274, 0.044491, 0.036293, 0.025261, 0.009298, -0.001929, 0.003786, 0.017838, 0.048975, 0.065857, 0.068120, 0.052345, 0.023541, 0.037947, 0.060023, 0.079815, 0.081860, 0.066400, 0.051384, 0.049064, 0.046231, 0.038643, 0.026593
#*# 	  0.034087, 0.050884, 0.068303, 0.066100, 0.050753, 0.030407, 0.009177, -0.008373, -0.000454, 0.008849, 0.019015, 0.025390, 0.030307, 0.023286, 0.016043, 0.029682, 0.045175, 0.058715, 0.062176, 0.054854, 0.047123, 0.041648, 0.048206, 0.045949, 0.033087
#*# 	  0.040462, 0.060003, 0.077655, 0.075306, 0.054607, 0.031291, 0.007532, -0.005500, -0.004404, 0.002889, 0.002832, -0.001734, 0.006093, 0.011369, 0.013583, 0.024744, 0.032166, 0.038773, 0.041815, 0.044604, 0.047024, 0.054150, 0.067260, 0.066694, 0.047848
#*# 	  0.031827, 0.045763, 0.060919, 0.056517, 0.039441, 0.019187, -0.001117, -0.013108, -0.012283, -0.008343, -0.003446, -0.004799, 0.002279, 0.006365, 0.009822, 0.017517, 0.021188, 0.022553, 0.024872, 0.032932, 0.050617, 0.075388, 0.101068, 0.099636, 0.069654
#*# 	  0.022322, 0.027462, 0.031365, 0.027171, 0.014205, 0.003542, -0.011544, -0.021424, -0.022577, -0.014338, -0.008153, -0.009848, -0.004030, 0.002551, 0.003803, 0.011786, 0.010721, 0.009818, 0.013159, 0.025792, 0.053096, 0.087020, 0.123615, 0.123018, 0.081766
#*# 	  0.014422, 0.010241, 0.010724, 0.005512, -0.001938, -0.008657, -0.018827, -0.023613, -0.021259, -0.012792, -0.006486, -0.009508, -0.004720, -0.000912, 0.000158, 0.004464, 0.004774, 0.003948, 0.006297, 0.019440, 0.042465, 0.078901, 0.114782, 0.112818, 0.074344
#*# 	  0.020336, 0.013168, 0.008275, 0.003379, -0.000844, -0.004191, -0.013647, -0.015215, -0.009955, -0.002586, 0.001835, -0.002046, 0.000000, 0.002238, 0.002122, 0.006365, 0.004865, 0.007527, 0.005841, 0.014350, 0.033037, 0.053274, 0.076694, 0.074992, 0.049839
#*# 	  0.024392, 0.014721, 0.007334, 0.004759, 0.003084, 0.001256, -0.007543, -0.013665, -0.007430, -0.002966, 0.001745, -0.003873, 0.000208, 0.002563, -0.002130, 0.002409, 0.001116, 0.002559, 0.003995, 0.009764, 0.015648, 0.024140, 0.034527, 0.033330, 0.016451
#*# 	  0.020641, 0.009974, 0.012391, 0.015064, 0.017758, 0.016508, 0.001428, -0.012254, -0.012821, -0.009559, -0.006761, -0.010244, -0.008140, -0.006799, -0.010099, -0.007452, -0.006760, -0.005364, -0.004447, 0.000392, -0.000098, -0.002201, 0.004366, 0.000648, -0.011953
#*# 	  0.006523, 0.010796, 0.025770, 0.039935, 0.048989, 0.044029, 0.019693, -0.003753, -0.017535, -0.020328, -0.020690, -0.023179, -0.021244, -0.019601, -0.022881, -0.019173, -0.016751, -0.017030, -0.014738, -0.010969, -0.012004, -0.016684, -0.016086, -0.020865, -0.032110
#*# 	  0.000030, 0.017117, 0.053608, 0.083548, 0.099645, 0.090644, 0.053241, 0.013970, -0.012641, -0.025728, -0.028942, -0.033118, -0.031764, -0.031401, -0.034381, -0.030200, -0.027085, -0.028099, -0.029405, -0.022369, -0.023864, -0.028222, -0.029866, -0.035638, -0.046753
#*# 	  -0.003114, 0.024310, 0.074064, 0.128687, 0.156359, 0.141789, 0.094530, 0.042413, 0.004913, -0.016674, -0.025211, -0.030469, -0.031719, -0.031243, -0.037049, -0.032445, -0.031498, -0.031572, -0.033682, -0.032601, -0.034241, -0.038894, -0.041298, -0.046301, -0.058155
#*# 	  -0.003594, 0.024721, 0.084286, 0.150533, 0.190915, 0.185518, 0.136779, 0.083076, 0.040920, 0.015570, 0.004991, -0.002834, -0.003590, -0.006985, -0.014072, -0.013285, -0.013097, -0.018346, -0.027781, -0.035465, -0.042710, -0.050229, -0.052100, -0.057817, -0.069315
#*# 	  -0.010476, 0.011085, 0.065982, 0.130370, 0.183451, 0.195977, 0.164387, 0.120935, 0.086502, 0.063320, 0.054794, 0.047186, 0.045279, 0.041586, 0.032994, 0.034678, 0.029636, 0.014731, -0.010081, -0.032221, -0.051350, -0.064650, -0.068169, -0.074084, -0.085185
#*# 	  -0.022702, -0.007376, 0.032025, 0.088216, 0.147925, 0.180467, 0.174715, 0.151924, 0.131180, 0.119278, 0.116252, 0.111856, 0.111685, 0.108327, 0.100331, 0.101981, 0.091405, 0.061626, 0.018197, -0.023267, -0.058212, -0.079854, -0.086022, -0.091501, -0.102101
#*# 	  -0.031328, -0.026783, 0.001641, 0.046769, 0.102594, 0.149893, 0.166435, 0.164893, 0.164311, 0.164622, 0.170087, 0.169030, 0.172968, 0.173483, 0.167260, 0.169465, 0.152690, 0.113139, 0.048965, -0.010527, -0.058593, -0.087658, -0.096535, -0.101867, -0.113620
#*# 	  -0.027538, -0.032050, -0.017220, 0.014881, 0.064051, 0.113228, 0.141090, 0.154456, 0.168109, 0.182771, 0.191983, 0.193389, 0.200186, 0.203267, 0.201075, 0.202406, 0.182212, 0.134204, 0.063399, -0.004464, -0.057289, -0.090016, -0.100185, -0.105129, -0.117835
#*# 	  -0.017896, -0.028894, -0.026748, -0.006426, 0.030837, 0.074090, 0.102069, 0.119797, 0.141490, 0.162304, 0.171780, 0.173138, 0.179677, 0.184251, 0.182493, 0.182074, 0.160244, 0.114431, 0.052519, -0.009910, -0.060431, -0.092522, -0.102945, -0.107377, -0.118801
#*# 	  0.003366, -0.012257, -0.019877, -0.011861, 0.012315, 0.044568, 0.065110, 0.081261, 0.103194, 0.124719, 0.130430, 0.127848, 0.133133, 0.137080, 0.133551, 0.134300, 0.115539, 0.080757, 0.032006, -0.016099, -0.058964, -0.089163, -0.098205, -0.101253, -0.110802
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 270.0
#*# min_y = 30.0
#*# max_y = 270.0
