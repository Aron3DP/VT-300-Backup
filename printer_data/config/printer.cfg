# THIS CONFIG IS FOR USE WITH Octopus 1.1, Beacon & EBB36

# Required Configs, Always include these
[include mainsail.cfg]
[include macros/*.cfg]
[include timelapse.cfg]
[include K-ShakeTune/*.cfg]

#####################################################################
#   MCU / Octopus / EBB36
#####################################################################

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_25002D000150335331383520-if00
#serial: platform-fd500000.pcie-pci-0000:01:00.0-usb-0:1.3:1.0
restart_method: command

[mcu EBB36]
canbus_uuid: d03347641955

[temperature_sensor Octopus]
sensor_type: temperature_mcu
sensor_mcu: mcu
min_temp: 0
max_temp: 100

[temperature_sensor EBB36]
sensor_type: temperature_mcu
sensor_mcu: EBB36
min_temp: 0
max_temp: 100

[temperature_sensor RPi]
sensor_type: temperature_host
min_temp: 10
max_temp: 100


#####################################################################
#   Machine
#####################################################################

[printer]
kinematics: corexy
max_velocity: 500  
max_accel: 10000
max_z_velocity: 15
max_z_accel: 350
square_corner_velocity: 5.0

[idle_timeout]
timeout: 1800


#####################################################################
#   X/Y Stepper Settings
#####################################################################

[stepper_x]
step_pin: PF13
dir_pin: PF12
enable_pin: !PF14
rotation_distance: 40
microsteps: 32
full_steps_per_rotation: 400
endstop_pin: tmc2209_stepper_x:virtual_endstop
position_min: 0
position_endstop: 300
position_max: 300
homing_speed: 40
homing_retract_dist: 0

[tmc2209 stepper_x]
uart_pin: PC4
diag_pin: ^PG6
interpolate: False
run_current: 1.0
sense_resistor: 0.110
stealthchop_threshold: 0
driver_SGTHRS: 140

[stepper_y]
step_pin: PG0
dir_pin: PG1
enable_pin: !PF15
rotation_distance: 40
microsteps: 32
full_steps_per_rotation: 400
endstop_pin: tmc2209_stepper_y:virtual_endstop
position_min: 0
position_endstop: 307
position_max: 307
homing_speed: 40
homing_retract_dist: 0

[tmc2209 stepper_y]
uart_pin: PD11
diag_pin: ^PG9
interpolate: False
run_current: 1.0
sense_resistor: 0.110
stealthchop_threshold: 0
driver_SGTHRS: 140


#####################################################################
#   Z Stepper Settings
#####################################################################

[stepper_z]
step_pin: PF11
dir_pin: !PG3
enable_pin: !PG5
rotation_distance: 4
microsteps: 32
full_steps_per_rotation: 200
endstop_pin: probe:z_virtual_endstop
position_max: 290
position_min: -2.5
homing_speed: 10
second_homing_speed: 3
homing_retract_dist: 0


[tmc2209 stepper_z]
uart_pin: PC6
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_z1]
step_pin: PG4
dir_pin: !PC1
enable_pin: !PA0
rotation_distance: 4
microsteps: 32
full_steps_per_rotation: 200

[tmc2209 stepper_z1]
uart_pin: PC7
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_z2]
step_pin: PF9
dir_pin: !PF10
enable_pin: !PG2
rotation_distance: 4
microsteps: 32
full_steps_per_rotation: 200

[tmc2209 stepper_z2]
uart_pin: PF2
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0


#####################################################################
#   Extruder
#####################################################################

[extruder]
step_pin: EBB36:PD0
dir_pin: !EBB36:PD1
enable_pin: !EBB36:PD2
rotation_distance: 22.50
gear_ratio: 50:8
microsteps: 16
full_steps_per_rotation: 200
nozzle_diameter: 0.400
filament_diameter: 1.75
heater_pin: EBB36:PB13
sensor_type: PT1000
pullup_resistor: 2200
sensor_pin: EBB36:PA3
min_temp: 10
max_temp: 350
max_power: 1.0
min_extrude_temp: 170
max_extrude_only_distance: 500
max_extrude_cross_section: 5.0
pressure_advance: 0.02
pressure_advance_smooth_time: 0.03

[tmc2209 extruder]
uart_pin: EBB36:PA15
interpolate: false
run_current: 0.60
sense_resistor: 0.110
stealthchop_threshold: 0

[firmware_retraction]
retract_length: 0.5
retract_speed: 35
unretract_extra_length: 0.0
unretract_speed: 35


#####################################################################
#   ADXL / Input Shaper
#####################################################################

[resonance_tester]
accel_chip: beacon
accel_per_hz: 100
probe_points: 150, 150, 20

[adxl345]
cs_pin: EBB36:PB12
spi_software_sclk_pin: EBB36:PB10
spi_software_mosi_pin: EBB36:PB11
spi_software_miso_pin: EBB36:PB2
axes_map: x,y,z

[input_shaper]
shaper_type_x = mzv
shaper_freq_x = 76.0
damping_ratio_x = 0.036
shaper_type_y = mzv
shaper_freq_y = 46.5
damping_ratio_y = 0.050


#####################################################################
#   Bed Heater
#####################################################################

[heater_bed]
heater_pin: PA2
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF3
max_power: 1
pwm_cycle_time: 0.0166
min_temp: 0
max_temp: 120


#####################################################################
#   Beacon
#####################################################################

[beacon]
serial: /dev/serial/by-id/usb-Beacon_Beacon_RevH_2A25C8345154364134202020FF143F31-if00
x_offset: 0
y_offset: 22
mesh_main_direction: x
mesh_runs: 2
contact_max_hotend_temperature: 270
home_xy_position: 150, 150
home_z_hop: 5
home_z_hop_speed: 30
home_xy_move_speed: 450
home_method: contact
home_method_when_homed: proximity
home_autocalibrate: unhomed
home_gcode_pre_x: _HOME_PRE_AXIS AXIS=X
home_gcode_post_x: _HOME_POST_AXIS AXIS=X
home_gcode_pre_y: _HOME_PRE_AXIS AXIS=Y
home_gcode_post_y: _HOME_POST_AXIS AXIS=Y
autocal_max_retries: 10


#####################################################################
#   Bed Mesh
#####################################################################

[bed_mesh]
speed: 450
mesh_min: 30,30
mesh_max: 270,270
probe_count: 25,25
algorithm: bicubic
zero_reference_position: 150, 150


#####################################################################
#   Z-Tilt
#####################################################################

[z_tilt]
z_positions:
   -50, 18
   150, 348
   350, 18
points:
   30, 8
   150, 258
   270, 8
speed: 450
retries: 10
retry_tolerance: 0.004
horizontal_move_z: 10


#####################################################################
#   Fan Control
#####################################################################

[fan]
pin: EBB36:PA0
kick_start_time: 0.5
off_below: 0.10

[heater_fan hotend_fan]
pin: EBB36:PA1
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0

[controller_fan Controller_Fan]
pin: PD12
kick_start_time: 0.5
fan_speed: 0.50
idle_timeout: 1800


#####################################################################
# 	Chamber Thermistor
#####################################################################

[temperature_sensor Chamber]
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF5
min_temp: 0
max_temp: 100
gcode_id: chamber_th

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 20.606
#*# pid_ki = 1.164
#*# pid_kd = 91.181
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 65.636
#*# pid_ki = 4.376
#*# pid_kd = 246.136
#*#
#*# [beacon model default]
#*# model_coef = 1.4224131212906368,
#*# 	1.760719564188449,
#*# 	0.7911225972478116,
#*# 	0.36898690428732855,
#*# 	0.4102733854437782,
#*# 	0.5147817459642499,
#*# 	-0.2234086581135876,
#*# 	-0.5490160428371165,
#*# 	0.19906423572651866,
#*# 	0.30632251599727406
#*# model_domain = 1.7921810629123274e-07,1.928696912017407e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 26.977205
#*# model_offset = 0.10900
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.015126, 0.012641, 0.014945, 0.012216, 0.004417, -0.001071, -0.004911, -0.003400, 0.003358, 0.008978, 0.002121, -0.010357, -0.005805, -0.001069, 0.010961, 0.022101, 0.026373, 0.032268, 0.029745, 0.032362, 0.034583, 0.032989, 0.031552, 0.028529, 0.020359
#*# 	0.011712, 0.011586, 0.016588, 0.006342, -0.005010, -0.009270, -0.009589, -0.004609, -0.002773, -0.000866, -0.004656, -0.013804, -0.008198, -0.011763, 0.000096, 0.017133, 0.026510, 0.027558, 0.021344, 0.027459, 0.030739, 0.033250, 0.029982, 0.023696, 0.019572
#*# 	0.009206, 0.005336, 0.010970, -0.002238, -0.012541, -0.019309, -0.019738, -0.015490, -0.011219, -0.006958, -0.014270, -0.024834, -0.020862, -0.016668, -0.003391, 0.009556, 0.013330, 0.020552, 0.019447, 0.021515, 0.024195, 0.022353, 0.020680, 0.018939, 0.012357
#*# 	0.000453, -0.010324, -0.000104, -0.013431, -0.021887, -0.029795, -0.034680, -0.028824, -0.022045, -0.012044, -0.022838, -0.040677, -0.036707, -0.028212, -0.013751, -0.003414, 0.001316, 0.012421, 0.015700, 0.015388, 0.014504, 0.016689, 0.016368, 0.014827, 0.004696
#*# 	-0.003227, -0.012034, -0.003024, -0.020661, -0.029738, -0.033784, -0.039814, -0.036302, -0.030728, -0.021215, -0.029779, -0.054068, -0.056267, -0.047913, -0.025244, -0.002849, -0.000132, 0.005749, 0.004795, 0.010078, 0.013000, 0.010367, 0.008563, 0.007009, 0.000878
#*# 	-0.013699, -0.016728, -0.003888, -0.019260, -0.031492, -0.038608, -0.040447, -0.039379, -0.035512, -0.025606, -0.040140, -0.060229, -0.065503, -0.059005, -0.031033, -0.006002, -0.003918, 0.000095, 0.000993, 0.005404, 0.012711, 0.011137, 0.007225, 0.005113, 0.000158
#*# 	-0.015655, -0.023386, -0.011657, -0.015680, -0.025940, -0.035200, -0.042343, -0.038541, -0.031125, -0.026049, -0.035548, -0.058905, -0.056730, -0.051131, -0.028358, -0.010517, -0.005636, 0.000681, -0.001841, 0.003264, 0.006932, 0.009899, 0.012945, 0.006055, 0.000976
#*# 	-0.017330, -0.022482, -0.014500, -0.016191, -0.026103, -0.031708, -0.035072, -0.032885, -0.027284, -0.024217, -0.029011, -0.042851, -0.037621, -0.036001, -0.022611, -0.009044, -0.005053, -0.000662, -0.001378, 0.002750, 0.011139, 0.014250, 0.013786, 0.007675, 0.005073
#*# 	-0.013382, -0.019347, -0.012972, -0.014458, -0.023074, -0.024281, -0.027683, -0.027236, -0.024295, -0.016638, -0.019433, -0.028678, -0.025410, -0.023434, -0.012542, -0.003878, -0.000560, 0.000340, 0.000268, 0.007348, 0.016884, 0.016681, 0.016605, 0.012486, 0.011819
#*# 	-0.012242, -0.018899, -0.014480, -0.013426, -0.019290, -0.023243, -0.029098, -0.030839, -0.023275, -0.015345, -0.017392, -0.027554, -0.020662, -0.019469, -0.010016, -0.003763, -0.003053, 0.000587, 0.002709, 0.008844, 0.014029, 0.015305, 0.015392, 0.015784, 0.012745
#*# 	-0.011309, -0.022828, -0.014254, -0.015385, -0.020378, -0.026851, -0.032024, -0.032866, -0.025887, -0.016511, -0.017356, -0.026514, -0.021756, -0.018870, -0.010675, -0.004714, -0.004121, -0.001935, -0.000571, 0.005654, 0.014865, 0.015957, 0.014445, 0.012508, 0.018674
#*# 	-0.012267, -0.016608, -0.009181, -0.010699, -0.016309, -0.023462, -0.027049, -0.028015, -0.025310, -0.015534, -0.013373, -0.018165, -0.014887, -0.015133, -0.005965, 0.002859, 0.001831, 0.003193, 0.000744, 0.010120, 0.019861, 0.019997, 0.015949, 0.018173, 0.027451
#*# 	0.001651, -0.006986, 0.003399, 0.001990, -0.007215, -0.013681, -0.018658, -0.015173, -0.011607, -0.003793, -0.004388, -0.011016, -0.005154, -0.001728, 0.003666, 0.009647, 0.010200, 0.010740, 0.010328, 0.017045, 0.025365, 0.026402, 0.027530, 0.029319, 0.036428
#*# 	0.010207, 0.002564, 0.008220, 0.006671, 0.000138, -0.007800, -0.012075, -0.010928, -0.005624, 0.000997, -0.000423, -0.006858, 0.000136, 0.003906, 0.008253, 0.010928, 0.013218, 0.016156, 0.013842, 0.019229, 0.025967, 0.028290, 0.028678, 0.037050, 0.034954
#*# 	0.009671, 0.001551, 0.005900, 0.005665, -0.006128, -0.011198, -0.014877, -0.014338, -0.010049, -0.003229, -0.004423, -0.012292, -0.005534, -0.001227, 0.003421, 0.008369, 0.008844, 0.008742, 0.008517, 0.013479, 0.021338, 0.020571, 0.018234, 0.023931, 0.028428
#*# 	0.005842, -0.004107, -0.000803, -0.002684, -0.011057, -0.016693, -0.022477, -0.024509, -0.017255, -0.010610, -0.012258, -0.020653, -0.016787, -0.011452, -0.003738, 0.001625, -0.000495, -0.001067, 0.000362, 0.008887, 0.012453, 0.009764, 0.008832, 0.008927, 0.009229
#*# 	-0.000120, -0.011239, -0.008924, -0.009962, -0.016303, -0.023385, -0.028208, -0.027621, -0.023535, -0.015909, -0.017997, -0.028479, -0.023327, -0.020254, -0.013063, -0.006751, -0.006713, -0.004833, -0.005920, -0.000275, 0.006479, 0.003926, 0.003351, -0.000127, -0.004302
#*# 	-0.006480, -0.017658, -0.013360, -0.015655, -0.021356, -0.026771, -0.031338, -0.030296, -0.026740, -0.022520, -0.022656, -0.030718, -0.026793, -0.026148, -0.020248, -0.010996, -0.009886, -0.008336, -0.010345, -0.003993, 0.002975, 0.002989, -0.002985, -0.007007, -0.010322
#*# 	-0.009552, -0.020202, -0.016563, -0.016341, -0.022134, -0.028989, -0.030569, -0.031409, -0.029203, -0.021739, -0.023952, -0.032777, -0.028261, -0.026600, -0.020609, -0.014456, -0.011167, -0.010064, -0.011203, -0.006295, 0.000624, -0.001085, -0.005041, -0.007953, -0.013421
#*# 	-0.012219, -0.023637, -0.019304, -0.020251, -0.023775, -0.028590, -0.032839, -0.034317, -0.030836, -0.026002, -0.028188, -0.037844, -0.031783, -0.029932, -0.025423, -0.019527, -0.017238, -0.014403, -0.016084, -0.011247, -0.005660, -0.007136, -0.009834, -0.012389, -0.015803
#*# 	-0.016575, -0.027587, -0.023682, -0.023959, -0.027392, -0.031986, -0.037942, -0.039543, -0.037967, -0.032410, -0.034949, -0.044718, -0.038205, -0.037833, -0.032135, -0.025671, -0.023330, -0.021235, -0.022699, -0.018347, -0.012963, -0.016095, -0.020419, -0.021323, -0.023605
#*# 	-0.017092, -0.027373, -0.024144, -0.023973, -0.027783, -0.032099, -0.038229, -0.039923, -0.041347, -0.035881, -0.038572, -0.047891, -0.040992, -0.040249, -0.033220, -0.025620, -0.024199, -0.021876, -0.024714, -0.020544, -0.016257, -0.018814, -0.023787, -0.026724, -0.030226
#*# 	-0.010354, -0.019411, -0.015406, -0.015087, -0.019646, -0.026634, -0.033500, -0.035831, -0.035968, -0.031972, -0.033806, -0.042331, -0.035907, -0.034088, -0.028282, -0.022941, -0.018970, -0.017293, -0.021733, -0.018217, -0.013939, -0.015239, -0.019408, -0.023169, -0.028846
#*# 	-0.000950, -0.009029, -0.003328, -0.002155, -0.009360, -0.017410, -0.023980, -0.027759, -0.028410, -0.023833, -0.024759, -0.034311, -0.025756, -0.025808, -0.023202, -0.018647, -0.015067, -0.013831, -0.017487, -0.014439, -0.008912, -0.009454, -0.014294, -0.017500, -0.025198
#*# 	0.014552, 0.007559, 0.014436, 0.013047, 0.005256, -0.002388, -0.007491, -0.011474, -0.009735, -0.006082, -0.005677, -0.017250, -0.008652, -0.010277, -0.010319, -0.006290, -0.004882, -0.003300, -0.006310, -0.001859, 0.004461, 0.001402, -0.000873, -0.007113, -0.013853
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 270.0
#*# min_y = 30.0
#*# max_y = 270.0
